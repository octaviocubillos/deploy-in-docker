#!/usr/bin/env node
"use strict";
import { Command } from "commander";
import { FileStack } from "./config";
import manages from "./manages";
import { handleError } from "./handlers";
import chalk from "chalk";
import * as crypto from "crypto";
import spinner from "./spinner";
import { saveLocalConfig } from "./user-config";
const program = new Command();
program.name("oton-pilot").version("0.0.0").description("Una herramienta CLI para desplegar y gestionar aplicaciones en contenedores, ya sea de forma local o remota, utilizando un archivo de configuraci\xF3n stack.yaml.").option("-f, --file <path>", "Especifica la ruta al archivo de configuraci\xF3n del stack.", "stack.yaml").option("-p, --profile <string>", "Define el perfil a utilizar del archivo de configuraci\xF3n.", "default").addHelpText("after", `
Ejemplos de uso:
  $ oton-pilot deploy -r my-service
  $ oton-pilot -f /path/to/stack.yaml -p production ps
  $ oton-pilot logs -f -c my-container`);
const globalOptions = program.opts();
const getInterface = async () => {
  const stack = new FileStack(globalOptions);
  if (!await stack.getService().isServiceRunning()) {
  }
  const profile = stack.getProfile();
  const manage = manages[profile.mode];
  if (!manage) {
    return handleError(`Error al obtener manage: ${profile.mode}`);
  }
  return new manage(stack);
};
const dbCommand = new Command("db").description("Gestiona la base de datos de estado local de oton-pilot.");
dbCommand.command("create").description("Crea una nueva instancia local de la base de datos en Docker si no existe.").option("-p, --port <number>", "Port.").action(async (options) => {
  const instance = await getInterface();
  spinner.start("Verificando el estado de la base de datos local...");
  const dbStatus = await instance.getLocalDbStatus();
  const creds = instance.profile.mongodb;
  if (dbStatus.exists) {
    spinner.succeed("La base de datos local ya existe.");
    console.log(chalk.bold("\nDetalles de la instancia existente:"));
    console.log(`  ${chalk.cyan("Estado:")} ${dbStatus.state}`);
    if (creds?.port) {
      console.log(`  ${chalk.cyan("URI de Conexi\xF3n:")} mongodb://${creds?.username || "?"}:${creds?.password ? "****" : "?"}@localhost:${creds.port}`);
    }
    if (creds?.username) {
      console.log(`  ${chalk.cyan("Usuario:")} ${creds.username}`);
      console.log(chalk.dim("  (La contrase\xF1a est\xE1 guardada en ~/.config/oton-pilot/credentials.yaml)"));
    }
  } else {
    spinner.info("No se encontr\xF3 una instancia de base de datos local. Creando una nueva...");
    const port = options.port || creds?.port || 20112;
    const username = creds?.username || "oton_user";
    const password = creds?.password || crypto.randomBytes(16).toString("hex");
    await instance.createLocalDbContainer({ username, password, port });
    instance.profile.mongodb = { username, password, port };
    if (instance.profile.host)
      instance.profile.mongodb.host = instance.profile.host;
    saveLocalConfig(instance.profile);
    console.log(chalk.bold("\xA1Base de datos creada! Guarda estas credenciales:"));
    console.log(`  ${chalk.cyan("Usuario:")} ${username}`);
    console.log(`  ${chalk.cyan("Contrase\xF1a:")} ${password}`);
  }
});
program.addCommand(dbCommand);
program.command("deploy").description("Construye y despliega los servicios definidos en el stack.").option("-r, --resource <name...>", "Nombre(s) de los recursos espec\xEDficos a desplegar.").action(async (options) => {
  try {
    const instance = await getInterface();
    await instance.deploy(options.resource);
  } catch (error) {
    handleError(error);
  } finally {
  }
}).addHelpText("after", `
Ejemplos:
  $ oton-pilot deploy
  $ oton-pilot deploy -r api-gateway database`);
program.command("config").description("Muestra la configuraci\xF3n del stack que se est\xE1 utilizando.").action(() => {
  try {
    const stack = new FileStack(globalOptions);
    console.log(chalk.green("\xA1Archivo de configuraci\xF3n cargado!"));
    console.log(JSON.stringify(stack.config, null, 2));
  } catch (error) {
    handleError(error);
  }
});
program.command("ps").alias("ls").description("Lista los contenedores asociados al stack del perfil actual.").option("-a, --all", "Mostrar todos los contenedores (en ejecuci\xF3n y detenidos).", false).action(async (options) => {
  const instance = await getInterface();
  await instance.ps(options);
}).addHelpText("after", `
Ejemplos:
  $ oton-pilot ps
  $ oton-pilot ps -a`);
program.command("remove").alias("rm").description("Detiene y elimina los contenedores asociados al stack.").action(async () => {
  const instance = await getInterface();
  await instance.removeStack();
});
program.command("logs").description("Muestra los logs de los contenedores del stack.").option("-t, --tail <number>", "N\xFAmero de l\xEDneas a mostrar desde el final de los logs.", "100").option("-f, --follow", "Seguir la salida de los logs en tiempo real.", false).option("-c, --container <name_or_id...>", "Nombre(s) o ID(s) de contenedores espec\xEDficos.").action(async (options) => {
  const instance = await getInterface();
  const tailCount = parseInt(options.tail, 10);
  if (isNaN(tailCount) || tailCount <= 0) {
    handleError(new Error("--tail debe ser un n\xFAmero positivo."));
    return;
  }
  await options.follow ? instance.followStackLogs(tailCount, options.container) : instance.showStackLogs(tailCount, options.container);
}).addHelpText("after", `
Ejemplos:
  $ oton-pilot logs
  $ oton-pilot logs -f
  $ oton-pilot logs -t 200 -c my-container`);
try {
  program.parse(process.argv);
} catch (error) {
  handleError(error);
}
